 # TabPFN合并数据集实验分析报告

## 1. 实验概述

本报告分析了TabPFN（Transformer-based Probabilistic Forecasting Neural Network）在合并多个数据集的条件下的预测性能。TabPFN是一种基于Transformer的表格数据预测模型，本实验旨在评估其在医疗数据域适应场景中的表现。

实验主要包含三种不同的设置：
- **基础合并实验**（combined_tabpfn）：将所有数据集直接合并后进行训练和测试
- **5折交叉验证实验**（combined_tabpfn_cv5）：在合并数据集上进行5折交叉验证
- **10折交叉验证实验**（combined_tabpfn_cv10）：在合并数据集上进行10折交叉验证

通过比较不同交叉验证设置下的模型性能，我们可以评估模型在混合数据集上的稳定性和泛化能力。

## 2. 数据集信息

本实验使用了三个不同来源的医疗数据集，统一命名为：

- **Dataset A**: AI4healthcare.xlsx（AI4health）
- **Dataset B**: HenanCancerHospital_features63_58.xlsx（Henan）
- **Dataset C**: GuangzhouMedicalHospital_features23_no_nan.xlsx（Guangzhou）

所有数据集均使用了23个共享特征：
```
Feature1, Feature2, Feature3, Feature4, Feature5, Feature14, Feature15, Feature17, Feature22, Feature39, Feature42, Feature43, Feature45, Feature46, Feature47, Feature48, Feature49, Feature50, Feature52, Feature53, Feature56, Feature57, Feature63
```

合并后的数据集包含来自三个不同数据源的样本，并添加了`DataSource`字段标记样本来源。

## 3. 实验设置

所有实验共享以下设置参数：
- **模型**: AutoTabPFN分类器
- **设备**: CUDA（GPU加速）
- **优化时间**: 30秒（max_time=30）
- **随机种子**: 42（random_state=42）
- **特征预处理**: StandardScaler标准化

不同实验的区别：
- **combined_tabpfn**: 可能是单次训练测试分割或简单交叉验证
- **combined_tabpfn_cv5**: 5折交叉验证，将数据集分为5份进行轮换验证
- **combined_tabpfn_cv10**: 10折交叉验证，将数据集分为10份进行轮换验证

## 4. 结果分析

### 4.1 总体性能比较

| 实验设置 | 平均准确率 | 平均AUC | 平均F1分数 | 类别0准确率 | 类别1准确率 | 平均运行时间(秒) |
|----------|------------|---------|------------|-------------|-------------|-----------------|
| 基础合并  | 0.596 | 0.633 | 0.651 | 0.563 | 0.623 | 70.43 |
| 5折CV    | 0.604 | 0.656 | 0.664 | 0.579 | 0.632 | ~15-16 |
| 10折CV   | 0.616 | 0.655 | 0.663 | 0.611 | 0.625 | ~15-16 |

> 注：数据来源于相应CSV文件中的精确数值，部分运行时间为估计值。

### 4.2 各数据集的单独性能（交叉验证中）

5折和10折交叉验证实验提供了更详细的每个数据集的性能指标，显示了模型在不同来源数据上的表现差异：

**10折交叉验证中各数据集性能：**

| 数据集 | 准确率 | AUC | F1分数 | 类别0准确率 | 类别1准确率 |
|--------|--------|-----|--------|-------------|-------------|
| Dataset A (AI4health) | 0.644 | 0.716 | 0.685 | 0.663 | 0.637 |
| Dataset B (Henan) | 0.556 | 0.565 | 0.484 | 0.689 | 0.454 |
| Dataset C (Guangzhou) | 0.652 | 0.609 | 0.714 | 0.467 | 0.734 |

**5折交叉验证中各数据集性能：**

| 数据集 | 准确率 | AUC | F1分数 | 类别0准确率 | 类别1准确率 |
|--------|--------|-----|--------|-------------|-------------|
| Dataset A (AI4health) | 0.623 | 0.705 | 0.668 | 0.669 | 0.606 |
| Dataset B (Henan) | 0.511 | 0.480 | 0.413 | 0.650 | 0.373 |
| Dataset C (Guangzhou) | 0.633 | 0.634 | 0.724 | 0.367 | 0.764 |

这种性能差异明显反映了数据集之间的分布差异，或者特征对不同人群的预测能力不同。值得注意的是，Dataset B (Henan) 的性能普遍较差，而Dataset A (AI4health) 在AUC指标上表现最佳。

### 4.3 交叉验证稳定性分析

10折交叉验证相比5折交叉验证具有以下特点：
- **样本利用率更高**：每次验证使用90%的数据进行训练
- **性能略有提升**：整体准确率从0.604提高到0.616
- **类别0准确率提升明显**：从0.579提高到0.611
- **AUC保持稳定**：两种设置下AUC都在0.65-0.66范围内

从标准差来看，10折交叉验证在某些指标上波动更大，这可能与增加了折数后，每折包含样本较少，对异常值更敏感有关。

## 5. 可视化分析

CV实验中的可视化图表显示：

1. **折间性能变化**：
   - 不同折之间的性能有一定波动，但整体保持相对稳定
   - AUC指标通常比准确率更稳定
   - 类别0（阴性样本）的准确率普遍高于类别1（阳性样本）

2. **类别不平衡问题**：
   - 在Dataset B中，类别0的准确率(0.689)显著高于类别1(0.454)
   - 而在Dataset C中，情况相反，类别1准确率(0.734)高于类别0(0.467)
   - 这表明不同数据集可能有不同的类别分布和类别预测难度

3. **数据集差异**：
   - Dataset A的AUC值(0.716)明显高于其他数据集，表明模型在该数据集上区分能力最强
   - Dataset B的F1分数最低(0.484)，这可能反映了数据分布偏差或特征相关性问题
   - Dataset C的类别1准确率最高(0.734)，但类别0准确率最低(0.467)，显示出严重的类别不平衡

## 6. 结论与建议

### 6.1 主要结论

1. TabPFN在合并数据集上表现出良好的稳定性，整体AUC值约0.65
2. 10折交叉验证相比5折交叉验证提供了略微提升的性能，特别是在类别0准确率方面
3. 不同数据集之间存在显著的性能差异，Dataset A表现最好，Dataset B表现最差
4. 类别不平衡问题在不同数据集中表现不同，需要针对具体数据集采取相应策略

### 6.2 改进建议

1. **类别不平衡处理**：
   - 考虑使用过采样、欠采样或合成样本技术
   - 针对Dataset B和Dataset C采用不同的类别平衡策略
   - 尝试调整决策阈值，优化各数据集的分类性能
   
2. **域适应方法**：
   - 考虑使用CORAL、MMD等域适应技术减少数据集之间的分布差异
   - 特别关注Dataset B的特征分布，寻找其性能较差的原因
   - 尝试特征选择方法，寻找对所有数据集均有较好预测能力的特征子集

3. **模型优化**：
   - 增加TabPFN的优化时间可能带来进一步的性能提升
   - 考虑集成多个TabPFN模型，如创建投票或堆叠系统
   - 为不同数据集构建专门的模型，然后进行集成

### 6.3 未来工作

1. 进一步分析性能差的样本，识别关键影响因素
2. 探索更复杂的域适应技术，减少不同数据集之间的差异
3. 与其他模型（如XGBoost、LightGBM、深度神经网络等）进行比较
4. 开发数据集特定的特征工程策略，提高各数据集的预测性能

## 7. 附录：文件说明

### 7.1 combined_tabpfn 文件夹
- `CombinedTabPFN-T30-R42-Plots.png`：性能可视化图表
- `CombinedTabPFN-T30-R42-Final.csv`：聚合性能指标
- `CombinedTabPFN-T30-R42.csv`：详细的折数据
- `combined_dataset.xlsx`：合并的数据集

### 7.2 combined_tabpfn_cv5 文件夹
- `CombinedTabPFN-T30-R42-Summary-Plots.png`：汇总性能图表
- `CombinedTabPFN-T30-R42-Summary.csv`：汇总性能数据
- `CombinedTabPFN-T30-R42-Fold-Plots.png`：各折性能图表
- `CombinedTabPFN-T30-R42-CV-PerDataset.csv`：各数据集性能
- `CombinedTabPFN-T30-R42-CV-Overall.csv`：整体交叉验证结果

### 7.3 combined_tabpfn_cv10 文件夹
- 结构与cv5类似，但包含10折的结果数据