## 4.6 评估指标

为全面评估TabPFN+TCA域适应方法的性能表现，本研究构建了包含分类性能指标、统计置信度评估、可视化分析和域距离度量的多维度评估体系。

### 分类性能指标

采用医疗AI领域常用的分类性能指标进行评估，各指标通过10折分层交叉验证（10-fold Stratified Cross-Validation）获得均值和标准差，确保结果的稳健性。分层交叉验证保证每个折中的类别分布与原始数据集一致，避免类别不平衡对评估结果的影响：

**(1) AUC（Area Under ROC Curve）**：作为主要评估指标，反映模型的整体分类能力和临床应用价值。ROC曲线描述不同决策阈值下真阳性率（TPR）与假阳性率（FPR）的关系：

$$
TPR(\tau) = \frac{TP(\tau)}{TP(\tau) + FN(\tau)}, \quad FPR(\tau) = \frac{FP(\tau)}{FP(\tau) + TN(\tau)}
$$

AUC定义为ROC曲线下的面积：

$$
AUC = \int_0^1 TPR(FPR^{-1}(\tau)) d\tau = \int_0^1 TPR(\tau) d(FPR(\tau))
$$

**(2) 准确率（Accuracy）**：评估模型的总体分类正确率：

$$
Accuracy = \frac{TP + TN}{TP + TN + FP + FN}
$$

**(3) F1分数**：精确率（Precision）和召回率（Recall）的调和平均数，适用于医疗数据的不平衡特性：

$$
Precision = \frac{TP}{TP + FP}, \quad Recall = \frac{TP}{TP + FN}
$$

$$
F1 = \frac{2 \times Precision \times Recall}{Precision + Recall} = \frac{2TP}{2TP + FP + FN}
$$

**(4) 敏感性（Sensitivity/Recall）**：评估模型识别阳性病例的能力，在医疗筛查中至关重要：

$$
Sensitivity = Recall = \frac{TP}{TP + FN}
$$

**(5) 特异性（Specificity）**：评估模型正确识别阴性病例的能力：

$$
Specificity = \frac{TN}{TN + FP}
$$

其中，$TP$、$TN$、$FP$、$FN$分别表示真阳性、真阴性、假阳性、假阴性样本数量。

对于$K=10$折分层交叉验证，数据集$\mathcal{D}$被分割为$K$个互不重叠的子集$\{\mathcal{D}_1, \mathcal{D}_2, \ldots, \mathcal{D}_K\}$，每个子集保持与原数据集相同的类别比例。第$k$次验证使用$\mathcal{D}_k$作为测试集，其余$K-1$个子集作为训练集。对于任意性能指标$M$，其最终评估结果为：

$$
\bar{M} = \frac{1}{K}\sum_{k=1}^K M_k, \quad \sigma_M = \sqrt{\frac{1}{K-1}\sum_{k=1}^K (M_k - \bar{M})^2}
$$

其中$M_k$为第$k$折的指标值，$\bar{M}$和$\sigma_M$分别为均值和标准差。

### 置信区间评估

采用95%置信区间（95% CI）量化性能指标的不确定性，通过Bootstrap重采样方法计算AUC指标的置信区间。设原始数据集为$\mathcal{D} = \{(\mathbf{x}_i, y_i)\}_{i=1}^n$，Bootstrap方法的具体步骤为：

**(1) Bootstrap重采样**：从原始数据集$\mathcal{D}$中有放回地随机抽取$n$个样本，构成第$b$次Bootstrap样本$\mathcal{D}_b^*$：

$$
\mathcal{D}_b^* = \{(\mathbf{x}_{i_j}^*, y_{i_j}^*)\}_{j=1}^n, \quad i_j \sim \text{Uniform}(1, 2, \ldots, n)
$$

**(2) 指标计算**：对每个Bootstrap样本$\mathcal{D}_b^*$训练模型并计算AUC值$AUC_b^*$，重复$B=1000$次获得Bootstrap分布：

$$
\{AUC_1^*, AUC_2^*, \ldots, AUC_B^*\}
$$

**(3) 置信区间构建**：通过计算Bootstrap分布的分位数获得95%置信区间：

$$
CI_{95\%} = [Q_{2.5\%}(\{AUC_b^*\}), Q_{97.5\%}(\{AUC_b^*\})]
$$

其中$Q_{\alpha}$表示$\alpha$分位数函数。该方法无需假设AUC分布的参数形式，能够准确估计非参数置信区间，为临床决策提供统计学支持和风险评估依据。

### 可视化分析

构建三类核心可视化图表评估模型性能：

**(1) ROC曲线**：展示不同阈值下敏感性与特异性的权衡关系，直观比较各方法的分类性能。ROC曲线通过绘制$TPR$对$FPR$的参数曲线实现：

$$
\{(FPR(\tau), TPR(\tau)) : \tau \in [0,1]\}
$$

其中$\tau$为分类阈值，理想分类器的ROC曲线经过点$(0,1)$，随机分类器对应对角线$TPR = FPR$。

**(2) 校准曲线（Calibration Curve）**：评估预测概率与实际阳性率的一致性，验证模型输出概率的可靠性。对于预测概率$\hat{p}_i$和真实标签$y_i$，将预测概率分为$K$个等宽区间$B_k = [k/K, (k+1)/K)$，计算每个区间内的平均预测概率和实际阳性率：

$$
\bar{p}_k = \frac{1}{|B_k|}\sum_{i: \hat{p}_i \in B_k} \hat{p}_i, \quad \bar{y}_k = \frac{1}{|B_k|}\sum_{i: \hat{p}_i \in B_k} y_i
$$

理想校准的模型应满足$\bar{p}_k = \bar{y}_k$对所有$k$成立，即校准曲线应与对角线$y=x$重合。

**(3) 决策曲线分析（Decision Curve Analysis）**：从临床净收益角度评估模型的实用价值，结合医疗成本效益进行综合评估。对于预测概率阈值$p_t \in [0,1]$，将预测概率$\hat{p}_i \geq p_t$的样本预测为阳性，净收益定义为：

$$
NB(p_t) = \frac{TP(p_t)}{n} - \frac{FP(p_t)}{n} \cdot \frac{p_t}{1-p_t}
$$

其中$TP(p_t)$和$FP(p_t)$分别为阈值$p_t$下的真阳性和假阳性数量，$\frac{p_t}{1-p_t}$为伤害-收益比（harm-to-benefit ratio），表示一个假阳性相对于一个真阳性的相对危害权重。该比值的经济学解释为：

$$
\frac{p_t}{1-p_t} = \frac{C_{FP}}{C_{TP}^{benefit} - C_{TP}^{cost}}
$$

其中$C_{FP}$为假阳性成本，$C_{TP}^{benefit}$为真阳性收益，$C_{TP}^{cost}$为真阳性治疗成本。

决策曲线同时比较以下基准策略的净收益：

- **全部治疗策略**：假设对所有患者进行治疗，净收益为
  $$NB_{all}(p_t) = \text{Prevalence} - (1-\text{Prevalence}) \cdot \frac{p_t}{1-p_t}$$

- **不治疗策略**：不对任何患者进行治疗，净收益恒为
  $$NB_{none} = 0$$

其中$\text{Prevalence} = \frac{1}{n}\sum_{i=1}^n y_i$为疾病患病率。决策曲线通过在阈值范围$p_t \in [0.01, 0.99]$内绘制$NB(p_t)$，帮助临床医生识别最优决策阈值和评估模型的临床实用性。

### 域适应效果评估

通过降维可视化和标准化域距离度量评估域适应的有效性：

**（1）PCA/t-SNE可视化**：展示域适应前后源域和目标域数据分布的变化，直观反映域对齐效果。

**（2）标准化域距离度量**：采用多种标准化距离指标量化域间差异。对于任意两个域的数据$\mathbf{X}_s$和$\mathbf{X}_t$，首先进行标准化预处理：

$$
\hat{\sigma} = \frac{\sigma(\mathbf{X}_s) + \sigma(\mathbf{X}_t)}{2}, \quad \hat{\mu} = \frac{\mu(\mathbf{X}_s) + \mu(\mathbf{X}_t)}{2}
$$

$$
\mathbf{X}_s^{norm} = \frac{\mathbf{X}_s - \hat{\mu}}{\hat{\sigma}}, \quad \mathbf{X}_t^{norm} = \frac{\mathbf{X}_t - \hat{\mu}}{\hat{\sigma}}
$$

**标准化Wasserstein距离**：

$$
W_{norm}(\mathbf{X}_s, \mathbf{X}_t) = \frac{1}{d}\sum_{i=1}^{d} W_1(X_{s,i}^{norm}, X_{t,i}^{norm})
$$

**标准化KL散度**：

$$
KL_{norm}(\mathbf{X}_s, \mathbf{X}_t) = \frac{1}{d}\sum_{i=1}^{d} \frac{KL(P_{s,i}^{norm} || P_{t,i}^{norm}) + KL(P_{t,i}^{norm} || P_{s,i}^{norm})}{2}
$$

**MMD距离**：考虑到TCA算法采用线性核进行域对齐，MMD度量作为辅助评估指标采用RBF核计算，以提供不同视角的域差异评估：

$$
MMD^2(\mathbf{X}_s, \mathbf{X}_t) = \frac{1}{n_s(n_s-1)}\sum_{i \neq j}k(x_i^s, x_j^s) + \frac{1}{n_t(n_t-1)}\sum_{i \neq j}k(x_i^t, x_j^t) - \frac{2}{n_s n_t}\sum_{i,j}k(x_i^s, x_j^t)
$$

其中$d$为特征维数，$W_1$为一维Wasserstein距离，$P_{s,i}^{norm}$和$P_{t,i}^{norm}$为标准化后第$i$个特征的概率分布，$k(·,·) = \exp(-\gamma||\mathbf{x}_i - \mathbf{x}_j||^2)$为RBF核函数。

需注意MMD度量采用RBF核而TCA使用线性核，因此MMD主要用于从非线性角度评估域间复杂分布差异，与TCA的线性域对齐形成互补评估。通过比较域适应前后距离指标的变化，从多个角度定量评估TCA算法的域对齐能力。

该多维度评估体系从分类性能、统计可靠性、临床实用性和域适应效果四个层面全面评估所提出方法，为TabPFN+TCA在跨医院医疗分类任务中的有效性提供充分的实证依据。
